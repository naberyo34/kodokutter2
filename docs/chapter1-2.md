# chapter1-2

## Sail

Laravel公式が提供するお手軽環境構築ツール。create-react-appみたいなもの。
内部的にはdockerが利用されている。

## Artisan

Laravel開発における便利コマンドを提供しているビルトインのコマンドラインツール。Sail環境では `sail artisan **~` というコマンドを使う。

## コントローラー

MVCのC。ルーターは受け取ったHTTPリクエストをコントローラーにルーティングし、処理を実行させる。

```shell
sail artisan make:controller Sample/IndexController
```

これを叩くと `Http`ディレクトリ配下にひな形のPHPファイルが生成される。

## ルーティング

ルーティングの追加は`routes`から手動で行う。URLと使用するコントローラー、および参照するメソッドを紐付ける。URLから引数を受け取ることもできる。

## シングルアクションコントローラー

1つのコントローラーに対して1つのエンドポイントがルーティングされている状態。

Laravelでは単一のコントローラーが複数のメソッドを持ち、それらを別々のエンドポイントに紐付けることも可能だが、ロジックの肥大化を招く場合もある。

PHPのマジックメソッドである `__invoke` を利用することで、単一のコントローラークラスに対して単一のメソッドしかルーティングできないというコード上の制約を作ることができる。

## Blade

Laravel標準のテンプレートエンジン。標準のPHPと異なり、タグの展開はデフォルトで `htmlspecialchars`によってエスケープされる（したくない場合は明示的に指定する）。

Bladeファイルは`resource/views`ディレクトリ上に作成し、コントローラー上で「Viewを返す」処理を書けばよい。

## データベースとの連携

Sail環境では標準でMySQLが同梱される。

- Artisanからマイグレーションファイル（PHP）を作成
- マイグレーションファイルを編集
- Artisanでマイグレーションを実行

することで、データベースを編集することができる。

### Seeder

シーダーを用いて「データの初期値を投入する」ことができる。アプリケーション上で初期データが必要な場合や、開発用のダミーデータを投入する際に使われる。最もシンプルな形で利用する場合、

- Artisanからシーダーファイルを作成
- シーダーファイルを編集
- Artisanでシーダーを実行

という手順を踏む（実際には、後述のFactoryと併用することが多い）。

memo: Laravel関連ファイル上では `Illuminate` という名前空間からの `use` が多数行われているが、これはLaravelの組み込み機能を読み込んでいる。ソースコードの実体は`vender`配下にある。

### Eloquent

EloquentはLaravelが搭載しているORM。
データベースとソースコードを紐付け、PHPコードからデータベースを操作できるようにする。

要するにこれがMVCのModelに相当する。

Eloquent Modelはデフォルトで **クラス名のスネークケース表記、かつ複数形** で命名されたテーブルと自動的にマッピングされる(`Tweet`で作成した場合、自動で`tweets`テーブルが紐づく)。マッピングされるテーブル名を変えたい場合は明示的に指定することも可能。

また、

- テーブルの主キーを`id`から変更している場合
- `id`はデフォルトで増分整数値（昇順に数値が付与される）だが、これをUUIDに変えたい場合
- タイムスタンプのカラム周りをデフォルトから変更（削除、名称変更）している場合

など、細かい設定をする場合は明示的に指定を行う。

### Factory

Eloquent Modelに対応するシードを作成する。ライブラリ`Faker`を用いることで、効率的にダミーデータを作成できる。

Factoryを利用する場合は、シーダーファイル上からFactoryを呼び出せばよい。Factoryの設定を用いて、任意の数ダミーデータを生成できる。

## Eloquent Modelからデータを取得する

作成したモデルはコントローラーから呼び出し、コントローラー内で任意の命令を行うことでデータベース内のデータを取得できる。

## ここまでのまとめ

Laravelでは、コントローラーやモデルの作成、DBのマイグレーションやシーダーの実行といった基本操作をArtisanから実行できる。

### 処理の流れ

- HTTPリクエストを受け取る→ルーティングされ、コントローラーに送られる
- コントローラーは必要に応じてモデルにアクセスし、データを処理してビューを返す
- このとき、モデルはデータベース本体から取得したデータを整形、加工する役割を担う
- Laravelにおける「ビュー」はテンプレートエンジン用いた動的HTMLでもよいし、APIサーバーとしてJSONだけを返却するような形でもよい

## リクエストを送る処理を作る

- 投稿を受け付けるコントローラーを作る
- リクエストの認証、送られてきたデータのバリデーション、取得を実装するための`FormRequest`クラスを`artisan`から作成する
- 作成した`FormRequest`クラスは、コントローラーで読み込める
- 作成したバリデーションのエラーメッセージは、Bladeの `@error`ディレクティブで表示できる

## CRUDアプリを作る基本的な流れ

投稿の取得、追加、編集、削除については概ね同じような手順で作成ができる。

- `artisan`でコントローラーを作る
- フォームが必要なら`FormRequest`を作る
- コントローラーからモデルを操作するロジックを書く
- 必要なビューを用意する
- ルーティングする
