# chapter3

## サービスコンテナ

Laravelの重要な仕組みのひとつ。

- クラスの依存関係の管理
- 依存性の注入

という役割を担う。

OOPにおいて、クラスAが内部でクラスBを呼び出してインスタンスを生成しているとき、Aの動作にはBが必須となり「クラスAはクラスBに依存している」といえる。

### 依存性の注入 (Dependency Injection, DI)

**「クラスの中で使いたいインスタンスやロジックを、クラスの外から受け取る」** こと。

具体的には、直接クラスAからクラスBを呼び出すのではなく、外部でクラスBから生成したインスタンスをコンストラクタの引数として受け取るようにする。

最終的に「クラスAが、クラスBのインスタンスを必要としている」こと自体は変わらないが、クラスBが責務を負うべきロジックに振り回されずクラスAを実装できるため、クラス単体でのテスト容易性が向上する（たとえば、ダミーのインスタンスを渡してテストすることも可能）。

## Laravelのサービスコンテナ

Laravelでは、あらかじめ用意した任意のサービスクラスをコントローラー上で読み込むだけで、「インスタンスの生成と注入」を意識せずとも依存性注入をうまいことやってくれる。

```php
{
    /**
     * Handle the incoming request.
     *
     * @param  \Illuminate\Http\Request  $request
     * @return \Illuminate\Http\Response
     */
    public function __invoke(Request $request, TweetService $tweetService)
    {
```

上記において、Laravelは`Request`クラスおよび`TweetService`クラスからインスタンスを生成し、`$request`や`$tweetService`として受け取るまでの処理を自動化している（ユーザーはクラスを`use`で宣言して読み込むだけでよい）。

## ログイン機能の実装

認証系は基本的にロジック丸ごと自前実装することは少ない。今回は `Laravel Breeze`を利用する。

※インストール時に既存コードを上書きしてくるため注意。フロントエンドにtailwindを組み込んできたりわりとがっつり手を入れてくる。

コードは自動生成されるものを利用する形で問題ないが、中身を理解しておかないと応用が効かない。以下でLaravel Breezeが生成する認証系コードについて解説する。

### ルーティングとミドルウェア

実体はauth.phpにあるが、get, postを括る形で「middleware」が指定されている。
ミドルウェアはコントローラーが実行する処理の前後に処理を挟み込みたいときに利用する。

artisanでミドルウェアを作成するとHttp/Middlewareにファイルが作成される。作ったミドルウェアはあらかじめKernel.php上でエイリアスを設定しておく必要があり、

- $middlewareはアプリケーション全体に作用する
- $routeMiddlewareは特定のルートに対して作用する

という違いがある。
ミドルウェアは、

```php
return $next($request);
```

の**前に書くか後ろに書くか** で元の処理との順番を制御することができる。たとえばアクセス制限をかける場合、データ取得やページ遷移（コントローラーが担っている処理）よりも **前に** 処理を実行しないとうまくいかない。

### 自分のアプリに応用する

これらを用いて追加でコードを書くことで、

- ログインしているユーザーのみが書き込みできるようにする
- ログインしているユーザーの情報をつぶやきとともに保存する
- 自分がつぶやいたもののみに編集、削除権限を与える

といったアプリケーションに必須の機能を実装できる。

Breezeは`guest`と`auth`のミドルウェアを提供しているので、要認証の機能を利用するルートにこれを挟み込むことで強制リダイレクトやViewの書き換えが行える。

Bladeの利用時は`@auth`ディレクティブで表示切り替えができるためかなりお手軽。

## 後からDBの構造を変える

artisanでマイグレーションファイルを作ればよい。`up()`は追加、拡張に、`down()`は削除、ロールバックに用いる。

## Eloquentを用いてモデル同士を紐付ける

EloquentはORMとしての機能を持っており、たとえばUserとTweetの関連付けをModelsファイルから行うことができる。

今回の場合、Userは多数のTweetを持つことができ、Tweetは必ず単一のUserに所属する。

## フロントエンド実装

Sail環境にはデフォルトでViteが入っている（モダン！）。

Bladeはテンプレートエンジンとしてのファイル分割機能を当然持っているが、`views/components/hoge/fuga.blade.php`は

```php
<x-hoge.fuga>
    ...
</x-hoge.fuga>
```

で呼び出せるようになっている。このとき、テンプレートに書いた`@slot`の位置にタグの中に入れた要素が展開される（JSXのchildrenっぽい挙動）。

これ以外にもpropsをコンポーネントに渡せるなどちょっとReactっぽい思想でBladeのコードを書くことができる。
